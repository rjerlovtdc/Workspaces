!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mousetrap")):"function"==typeof define&&define.amd?define(["exports","mousetrap"],t):t((e=e||self).widgetApiLib={},e.Mousetrap)}(this,function(e,t){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;const s="WIDGET_API_PROTOCOL_1",r=["https://agent.puzzel.com","https://devagent.puzzel.com","https://ciagent.puzzel.com","https://testagent.puzzel.com","https://qaagent.puzzel.com","https://telenor-se.puzzel.com","https://agent.telenor.se","https://devazagent.puzzel.com"],i=2e4;class o{constructor(e,s,{receiver:r}){this._id=1e3,this._calls=new Map,this._port=e,this._config=s,this._subscriptions={},this._observers={},this._callbacks={},this._mt=new t,e.onmessage=(t=>{this._receiver(t),r&&r(t,e)}),this._applyKeyboardPolicy(s.keyboardPolicy||{}),this.on("SYSTEM_APPLY_KEYBOARD_POLICY",e=>this._applyKeyboardPolicy(e))}get options(){return this._config}get port(){return this._port}_applyKeyboardPolicy(e){this._mt.reset(),Object.keys(e).forEach(t=>{const s=e[t],{command:r,target:i}=s,o=String(s.combo).toLowerCase();this._mt.bind(o,e=>{e.preventDefault?e.preventDefault():e.returnValue=!1,this.call("events.publish",r,{target:i})})})}_receiver(e){const{type:t}=e.data;"event"===t&&this._handleEvent(e.data),"changed"===t&&this._handlePropertyChange(e.data),"result"===t&&this._handleResult(e.data),"error"===t&&this._handleError(e.data),"call"===t&&this._handleCallbackCall(e.data)}_handleResult({value:e,id:t}){if(this._calls.has(t)){const{resolve:s}=this._calls.get(t);this._calls.delete(t),s(e)}}_handleError({value:e,id:t}){if(this._calls.has(t)){const{reject:s}=this._calls.get(t);this._calls.delete(t),s(e)}}_handleEvent({name:e,value:t}){this._subscriptions[e]&&this._subscriptions[e].forEach(e=>e(t))}_handlePropertyChange({name:e,old:t,new:s}){this._observers[e]&&this._observers[e].forEach(e=>e(s,t))}_handleCallbackCall({name:e,value:t,id:s}){this._callbacks[e]?new Promise(s=>s(this._callbacks[e](...t))).then(e=>{this._port.postMessage({result:e,id:s})}).catch(e=>{this._port.postMessage({error:e,id:s})}):this._port.postMessage({error:"Callback not found.",id:s})}on(e,t){const s=Array.isArray(this._subscriptions[e]);return this._subscriptions[e]=s?this._subscriptions[e].concat(t):[t],s||this._port.postMessage({subscribe:e}),()=>{const s=this._subscriptions[e];s&&(this._subscriptions[e]=s.filter(e=>e!==t))}}call(e,...t){return function(e,t){let s;const r=new Promise((e,r)=>{s=setTimeout(()=>r(new Error("Promise timeout")),t)});return Promise.race([e,r]).then(e=>(s&&clearTimeout(s),e)).catch(e=>{throw s&&clearTimeout(s),e})}(new Promise((s,r)=>{this._calls.set(this._id,{resolve:s,reject:r}),this._port.postMessage({call:e,args:t,id:this._id}),this._id+=1}),i)}get(e){return this.call(e)}watch(e,t){const s=Array.isArray(this._observers[e]);return this._observers[e]=s?this._observers[e].concat(t):[t],s||this._port.postMessage({watch:e}),()=>{const s=this._observers[e];s&&(this._observers[e]=s.filter(e=>e!==t))}}ready(){this._port.postMessage({ready:!0})}callback(e,t){return this._callbacks[e]=t,()=>{delete this._callbacks[e]}}}e.DEFAULT_ORIGINS=r,e.WIDGET_API_PROTOCOL_VERSION=s,e.connect=function(e=r,t={}){return new Promise((r,i)=>{Array.isArray(e)||(e=[e]),window.addEventListener("message",s=>{e.indexOf(s.origin)>=0?r(new o(s.ports[0],s.data,t)):i(new Error("Connection to host rejected: The origin doesn't match."))},{once:!0}),e.forEach(e=>window.parent.postMessage(s,e))})},Object.defineProperty(e,"__esModule",{value:!0})});